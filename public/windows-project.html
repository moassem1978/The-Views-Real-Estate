<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Universal Project Management Form | The Views Real Estate</title>
  <style>
    /* Base styles */
    body {
      font-family: 'Tahoma', sans-serif;
      background-color: #f7f7f7;
      color: #333;
      line-height: 1.6;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    h1, h2, h3 {
      font-family: 'Playfair Display', 'Times New Roman', serif;
      color: #964B00;
    }

    h1 {
      font-size: 2rem;
      text-align: center;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #B87333;
      padding-bottom: 0.5rem;
    }

    /* Form styles */
    .form-container {
      background-color: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }

    button {
      background-color: #964B00;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #B87333;
    }

    .btn-secondary {
      background-color: #333;
    }

    .btn-secondary:hover {
      background-color: #555;
    }

    .error-message {
      color: #ff0033;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    .success-message {
      color: #00aa33;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }

    .image-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .image-preview img {
      width: 150px;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
    }

    .required::after {
      content: " *";
      color: #ff0033;
    }

    .image-upload-container {
      border: 2px dashed #ddd;
      padding: 20px;
      text-align: center;
      margin-bottom: 1rem;
      border-radius: 4px;
    }

    .form-row {
      display: flex;
      gap: 20px;
    }

    .form-col {
      flex: 1;
    }

    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
      }
    }

    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
      text-transform: uppercase;
    }

    .status-active {
      background-color: #d4edda;
      color: #155724;
    }

    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-inactive {
      background-color: #f8d7da;
      color: #721c24;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 1rem;
      color: #964B00;
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .chip-input {
      margin-top: 0.5rem;
    }
    
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    
    .chip {
      background-color: #e9e9e9;
      padding: 5px 10px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      font-size: 0.9rem;
    }
    
    .chip button {
      background: none;
      border: none;
      color: #666;
      margin-left: 5px;
      cursor: pointer;
      padding: 0 5px;
    }
    
    .add-chip-btn {
      margin-top: 10px;
      background-color: #f0f0f0;
      color: #333;
    }
  </style>
</head>
<body>
  <a href="/" class="back-link">‚Üê Back to Home</a>

  <h1>Universal Project Management</h1>

  <div class="form-container">
    <div id="project-message"></div>

    <form id="project-form">
      <input type="hidden" id="project-id" name="id">
      
      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="projectName" class="required">Project Name</label>
            <input type="text" id="projectName" name="projectName" required>
          </div>
        </div>
        <div class="form-col">
          <div class="form-group">
            <label for="location" class="required">Location</label>
            <select id="location" name="location" required>
              <option value="">Select Location</option>
              <option value="Cairo">Cairo</option>
              <option value="Zayed">Zayed</option>
              <option value="North Coast">North Coast</option>
              <option value="Red Sea">Red Sea</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="description" class="required">Description</label>
        <textarea id="description" name="description" rows="4" required></textarea>
      </div>

      <div class="form-group">
        <label for="aboutDeveloper" class="required">About Developer</label>
        <textarea id="aboutDeveloper" name="aboutDeveloper" rows="4" required></textarea>
      </div>

      <div class="form-group">
        <label for="status">Status</label>
        <select id="status" name="status">
          <option value="Active">Active</option>
          <option value="Under Construction">Under Construction</option>
          <option value="Completed">Completed</option>
          <option value="Coming Soon">Coming Soon</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Unit Types</label>
        <div class="chip-input">
          <input type="text" id="unit-type-input" placeholder="Add unit type (e.g., Apartment, Villa)">
          <button type="button" class="add-chip-btn" onclick="addUnitType()">Add</button>
          <div id="unit-types-container" class="chips"></div>
          <input type="hidden" id="unitTypes" name="unitTypes">
        </div>
      </div>

      <div class="form-group">
        <label for="project-images">Project Images</label>
        <div class="image-upload-container">
          <input type="file" id="project-images" name="images" multiple accept="image/*">
          <p>Drag & drop images here or click to select</p>
        </div>
        <div id="image-preview" class="image-preview"></div>
        <div id="image-upload-status"></div>
      </div>

      <div class="form-group">
        <button type="submit" id="submit-btn">Save Project</button>
        <button type="button" id="clear-btn" class="btn-secondary">Clear Form</button>
      </div>
    </form>
  </div>

  <div class="form-container" style="margin-top: 2rem;">
    <h2>Existing Projects</h2>
    <div id="projects-list"></div>
  </div>

  <script>
    // Global variables
    let allProjects = [];
    let currentProject = {};
    let unitTypes = [];
    let uploadedImages = [];
    let existingImages = [];

    // Load projects when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      fetchProjects();
      document.getElementById('project-form').addEventListener('submit', handleSubmit);
      document.getElementById('clear-btn').addEventListener('click', clearForm);
      document.getElementById('project-images').addEventListener('change', handleImageSelection);
    });

    // Fetch projects from the API
    async function fetchProjects() {
      try {
        const response = await fetch('/api/projects');
        if (!response.ok) {
          throw new Error('Failed to fetch projects');
        }
        const data = await response.json();
        allProjects = data.data || [];
        renderProjectsList();
      } catch (error) {
        console.error('Error fetching projects:', error);
        document.getElementById('projects-list').innerHTML = `<p>Error loading projects: ${error.message}</p>`;
      }
    }

    // Render the list of projects
    function renderProjectsList() {
      const projectsContainer = document.getElementById('projects-list');
      
      if (allProjects.length === 0) {
        projectsContainer.innerHTML = '<p>No projects available.</p>';
        return;
      }

      let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
      html += '<thead><tr style="background-color: #f2f2f2; text-align: left;">';
      html += '<th style="padding: 10px; border-bottom: 1px solid #ddd;">Name</th>';
      html += '<th style="padding: 10px; border-bottom: 1px solid #ddd;">Location</th>';
      html += '<th style="padding: 10px; border-bottom: 1px solid #ddd;">Status</th>';
      html += '<th style="padding: 10px; border-bottom: 1px solid #ddd;">Actions</th>';
      html += '</tr></thead><tbody>';

      allProjects.forEach(project => {
        html += `<tr style="border-bottom: 1px solid #eee;">`;
        html += `<td style="padding: 10px;">${project.projectName}</td>`;
        html += `<td style="padding: 10px;">${project.location}</td>`;
        
        let statusClass = 'status-active';
        if (project.status === 'Under Construction') statusClass = 'status-pending';
        if (project.status === 'Coming Soon') statusClass = 'status-inactive';
        
        html += `<td style="padding: 10px;"><span class="status-badge ${statusClass}">${project.status}</span></td>`;
        html += `<td style="padding: 10px;">
                  <button onclick="editProject(${project.id})" style="background-color: #4b6584; margin-right: 5px;">Edit</button>
                  <button onclick="deleteProject(${project.id})" style="background-color: #eb3b5a;">Delete</button>
                </td>`;
        html += `</tr>`;
      });

      html += '</tbody></table></div>';
      projectsContainer.innerHTML = html;
    }

    // Handle form submission
    async function handleSubmit(e) {
      e.preventDefault();
      const submitBtn = document.getElementById('submit-btn');
      const messageEl = document.getElementById('project-message');
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';
      messageEl.innerHTML = '';

      try {
        // Get form data
        const projectId = document.getElementById('project-id').value;
        const formData = new FormData();
        
        formData.append('projectName', document.getElementById('projectName').value);
        formData.append('location', document.getElementById('location').value);
        formData.append('description', document.getElementById('description').value);
        formData.append('aboutDeveloper', document.getElementById('aboutDeveloper').value);
        formData.append('status', document.getElementById('status').value);
        formData.append('unitTypes', JSON.stringify(unitTypes));

        // Add uploaded images to the form data
        const fileInput = document.getElementById('project-images');
        if (fileInput.files.length > 0) {
          for (let i = 0; i < fileInput.files.length; i++) {
            formData.append('images', fileInput.files[i]);
          }
        }

        // If editing, add existing images
        if (projectId) {
          formData.append('existingImages', JSON.stringify(existingImages));
        }

        const url = projectId 
          ? `/api/projects/${projectId}` 
          : '/api/projects';
        
        const method = projectId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          body: formData
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to save project');
        }

        const result = await response.json();
        
        messageEl.innerHTML = `<div class="success-message">
          Project ${projectId ? 'updated' : 'created'} successfully!
        </div>`;
        
        clearForm();
        fetchProjects();
      } catch (error) {
        console.error('Error saving project:', error);
        messageEl.innerHTML = `<div class="error-message">
          Error: ${error.message}
        </div>`;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save Project';
      }
    }

    // Edit project
    function editProject(id) {
      const project = allProjects.find(p => p.id === id);
      if (!project) return;
      
      currentProject = project;
      
      document.getElementById('project-id').value = project.id;
      document.getElementById('projectName').value = project.projectName;
      document.getElementById('location').value = project.location;
      document.getElementById('description').value = project.description;
      document.getElementById('aboutDeveloper').value = project.aboutDeveloper;
      document.getElementById('status').value = project.status || 'Active';
      
      // Load unit types
      unitTypes = Array.isArray(project.unitTypes) ? [...project.unitTypes] : [];
      renderUnitTypes();
      
      // Load images
      existingImages = project.images || [];
      renderImagePreviews();
      
      // Scroll to form
      document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
    }

    // Delete project
    async function deleteProject(id) {
      if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/projects/${id}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          throw new Error('Failed to delete project');
        }
        
        fetchProjects();
        
        const messageEl = document.getElementById('project-message');
        messageEl.innerHTML = `<div class="success-message">Project deleted successfully!</div>`;
        
        setTimeout(() => {
          messageEl.innerHTML = '';
        }, 3000);
      } catch (error) {
        console.error('Error deleting project:', error);
        
        const messageEl = document.getElementById('project-message');
        messageEl.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
      }
    }

    // Clear form
    function clearForm() {
      document.getElementById('project-form').reset();
      document.getElementById('project-id').value = '';
      document.getElementById('image-preview').innerHTML = '';
      document.getElementById('unit-types-container').innerHTML = '';
      document.getElementById('image-upload-status').innerHTML = '';
      
      unitTypes = [];
      uploadedImages = [];
      existingImages = [];
      currentProject = {};
    }

    // Handle image selection
    function handleImageSelection(e) {
      const files = e.target.files;
      if (!files || files.length === 0) return;
      
      const previewContainer = document.getElementById('image-preview');
      const statusContainer = document.getElementById('image-upload-status');
      
      // Clear previous previews if any
      if (!existingImages.length) {
        previewContainer.innerHTML = '';
      }
      
      statusContainer.innerHTML = `<p>Selected ${files.length} image(s)</p>`;
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.alt = 'Project Image Preview';
          previewContainer.appendChild(img);
        };
        
        reader.readAsDataURL(file);
      }
    }

    // Render image previews
    function renderImagePreviews() {
      const previewContainer = document.getElementById('image-preview');
      previewContainer.innerHTML = '';
      
      if (existingImages && existingImages.length > 0) {
        existingImages.forEach((image, index) => {
          const imgContainer = document.createElement('div');
          imgContainer.style.position = 'relative';
          
          const img = document.createElement('img');
          img.src = image.startsWith('/') ? image : `/${image}`;
          img.alt = 'Project Image';
          
          const removeBtn = document.createElement('button');
          removeBtn.textContent = 'X';
          removeBtn.style.position = 'absolute';
          removeBtn.style.top = '5px';
          removeBtn.style.right = '5px';
          removeBtn.style.backgroundColor = '#eb3b5a';
          removeBtn.style.color = 'white';
          removeBtn.style.border = 'none';
          removeBtn.style.borderRadius = '50%';
          removeBtn.style.width = '25px';
          removeBtn.style.height = '25px';
          removeBtn.style.cursor = 'pointer';
          
          removeBtn.onclick = function() {
            existingImages.splice(index, 1);
            renderImagePreviews();
          };
          
          imgContainer.appendChild(img);
          imgContainer.appendChild(removeBtn);
          previewContainer.appendChild(imgContainer);
        });
      }
    }

    // Add unit type to the list
    function addUnitType() {
      const input = document.getElementById('unit-type-input');
      const value = input.value.trim();
      
      if (value && !unitTypes.includes(value)) {
        unitTypes.push(value);
        renderUnitTypes();
        input.value = '';
      }
    }

    // Remove unit type from the list
    function removeUnitType(index) {
      unitTypes.splice(index, 1);
      renderUnitTypes();
    }

    // Render unit types as chips
    function renderUnitTypes() {
      const container = document.getElementById('unit-types-container');
      container.innerHTML = '';
      
      unitTypes.forEach((type, index) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = type;
        
        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'x';
        removeBtn.type = 'button';
        removeBtn.onclick = () => removeUnitType(index);
        
        chip.appendChild(removeBtn);
        container.appendChild(chip);
      });
      
      // Update the hidden input value
      document.getElementById('unitTypes').value = JSON.stringify(unitTypes);
    }
  </script>
</body>
</html>